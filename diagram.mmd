flowchart TB
  Internet["Internet Users (Clients)"]
  Admin["Admin via VPN or SSM"]
  CDN["CDN CloudFront"]
  CICD["CI/CD Pipeline"]

  %% VPC / Networking
  subgraph VPC["Production VPC Multi AZ"]
    direction TB
    IGW["Internet Gateway"]
    NAT1["NAT Gateway AZ1"]
    NAT2["NAT Gateway AZ2"]
    RT_PUB["Public Route Table"]
    RT_PRV["Private Route Table"]
    NACL["Network ACLs"]
    VPCFlow["VPC Flow Logs to CloudWatch S3"]

    subgraph AZ1["AZ1"]
      PUB1["Public Subnet AZ1"]
      PRV1["Private App Subnet AZ1"]
      DB1["Private DB Subnet AZ1"]
    end

    subgraph AZ2["AZ2"]
      PUB2["Public Subnet AZ2"]
      PRV2["Private App Subnet AZ2"]
      DB2["Private DB Subnet AZ2"]
    end
  end

  %% Public tier
  ALB["Internet facing ALB TLS termination"]
  Bastion["Bastion Host"]
  ECR["ECR Private Registry"]
  S3_Static["S3 Static Assets"]

  %% EKS
  EKS_Cluster["Amazon EKS Cluster Private Endpoint"]
  subgraph EKS_Control["EKS Control Plane and IAM"]
    CP["Managed control plane"]
    OIDC["IAM OIDC Provider"]
    IRSA["IRSA service account roles"]
  end

  subgraph Compute["EKS Compute Private Subnets"]
    NG_App["Node Group app"]
    NG_System["Node Group system"]
    Fargate["Fargate Profiles"]
    CA["Cluster Autoscaler"]
    HPA["Horizontal Pod Autoscaler"]
    ServiceMesh["Service Mesh Istio Linkerd"]
  end

  %% Data & state
  RDS["RDS PostgreSQL Multi AZ Encrypted"]
  Redis["ElastiCache Redis Cluster Mode Multi AZ"]
  Secrets["Secrets Manager Parameter Store"]
  S3_State["S3 Bucket Terraform State Versioned"]
  DynamoDB["DynamoDB Lock Table"]

  %% Endpoints & Security
  VPCE_S3["VPC Endpoint S3"]
  VPCE_ECR["VPC Endpoint ECR"]
  VPCE_SM["VPC Endpoint Secrets Manager"]
  IAM["IAM Roles Policies"]
  KMS["KMS Keys"]
  GuardDuty["GuardDuty Security Hub"]

  %% Observability
  CloudWatch["CloudWatch Logs Metrics"]
  Prometheus["Prometheus"]
  Grafana["Grafana"]
  XRay["X Ray"]
  Scanner["Image Scanning"]
  SIEM["SIEM Security Ops"]

  %% Terraform repo
  subgraph Terraform["Terraform Repository"]
    Modules["Modules vpc eks rds redis s3 iam"]
    Root["Root env prod stage backend s3 dynamodb"]
  end

  %% Connections external
  Internet -->|HTTPS| CDN
  CDN -->|HTTPS| ALB
  Admin -->|SSM| Bastion
  CICD -->|Push image| ECR
  CICD -->|Terraform apply| S3_State
  CICD -->|Deploy manifests| EKS_Cluster

  %% Networking connections
  IGW --> PUB1
  IGW --> PUB2
  PUB1 --> NAT1
  PUB2 --> NAT2
  NAT1 --> PRV1
  NAT2 --> PRV2
  PRV1 --> DB1
  PRV2 --> DB2
  VPCFlow -.-> CloudWatch

  PUB1 --> ALB
  PUB2 --> ALB
  PUB1 --> ECR
  PUB1 --> S3_Static
  PUB1 --> Bastion

  ALB -->|Ingress HTTPS| EKS_Cluster
  EKS_Cluster --> CP
  CP --> OIDC
  OIDC --> IRSA
  EKS_Cluster --> Compute
  Compute --> NG_App
  Compute --> NG_System
  Compute --> Fargate
  NG_App --> HPA
  NG_System --> CA
  Compute --> ServiceMesh

  PRV1 --> RDS
  PRV2 --> RDS
  PRV1 --> Redis
  PRV2 --> Redis
  PRV1 --> Secrets

  PRV1 --> VPCE_S3
  PRV2 --> VPCE_ECR
  PRV1 --> VPCE_SM

  S3_State --> DynamoDB
  S3_State -->|Encrypted| KMS
  RDS -->|Encrypted| KMS
  Redis -->|Encrypted| KMS
  Secrets -->|Encrypted| KMS
  IAM -->|Grants| EKS_Cluster
  IAM -->|Grants| CICD
  GuardDuty -->|Alerts| SIEM

  ECR --> Scanner
  Scanner --> CICD
  CloudWatch --> Prometheus
  Prometheus --> Grafana
  EKS_Cluster --> XRay

  Terraform --> Modules
  Terraform --> Root
  Root --> S3_State
