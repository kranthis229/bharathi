flowchart LR
  subgraph "VPC (multi-AZ)"
    direction TB
    IGW[Internet Gateway]
    PublicSubnetA[Public Subnet AZ-A]
    PublicSubnetB[Public Subnet AZ-B]
    PrivateSubnetA[Private Subnet AZ-A]
    PrivateSubnetB[Private Subnet AZ-B]
    NAT_A[NAT Gateway AZ-A]
    NAT_B[NAT Gateway AZ-B]
  end

  subgraph "Management / State"
    S3State[(S3: terraform-state (versioned, encrypted))]
    DDBLock[(DynamoDB: tfstate lock)]
    CodeRepo[(GitHub repo)]
    GitHubActions[(GitHub Actions)]
  end

  subgraph "EKS & App (Private)"
    EKS[EKS Cluster (private)]
    NodeGroup1[Node Group - spot/on-demand mix]
    NodeGroup2[Node Group - GPU/worker]
    Istio[Istio Service Mesh]
    Helm[Helm Charts]
    ALB[ALB / AWS Load Balancer Controller]
    AppPods[App Pods (hello-world microservice)]
  end

  subgraph "Data Layer (Private)"
    RDS[(RDS PostgreSQL Multi-AZ)]
    Redis[(ElastiCache Redis Cluster)]
    S3Assets[(S3: static assets)]
  end

  subgraph "Observability & Ops"
    CloudWatch[CloudWatch (Metrics, Logs, Dashboards)]
    LogGroup[(Log Group + Subscription)]
    LambdaPII[(Lambda: strip PII, triggered by subscription)]
    SNS[(SNS topic)]
    AlarmActions[(Alarm actions)]
    GuardDuty[(GuardDuty)]
    Config[(AWS Config rules)]
  end

  subgraph "Security"
    KMS[(KMS keys)]
    IAM[(IAM roles & policies)]
    SSM[(SSM Parameter Store - SecureString)]
  end

  subgraph "Optional ChatOps"
    ChatLambda[(Lambda: ChatOps - Gemini)]
    Slack[Slack Webhook]
  end

  CodeRepo -->|push| GitHubActions
  GitHubActions -->|terraform fmt/validate & unit tests & gemini scan| CodeRepo
  GitHubActions --> S3State
  GitHubActions --> ECR[(ECR repository)]
  GitHubActions -->|apply non-prod| EKS
  GitHubActions -->|deploy via helm| Helm

  IGW --> PublicSubnetA
  IGW --> PublicSubnetB
  PublicSubnetA --> NAT_A
  PublicSubnetB --> NAT_B
  NAT_A --> PrivateSubnetA
  NAT_B --> PrivateSubnetB

  PrivateSubnetA --> EKS
  PrivateSubnetB --> EKS
  EKS --> NodeGroup1
  EKS --> NodeGroup2
  EKS --> Istio
  EKS --> AppPods
  ALB --> AppPods
  AppPods -->|reads secrets| SSM
  AppPods -->|stores static| S3Assets
  AppPods -->|connects| RDS
  AppPods -->|connects| Redis

  AppPods -->|app logs| CloudWatch
  EKS -->|infra logs| CloudWatch
  CloudWatch --> LogGroup
  LogGroup --> LambdaPII
  LambdaPII --> S3Assets
  CloudWatch -->|alarms| SNS
  SNS --> AlarmActions

  GuardDuty ---|detect threats| CloudWatch
  Config ---|rules| AlarmActions

  KMS --> RDS
  KMS --> S3Assets
  KMS --> Redis
  IAM --> EKS
  IAM --> GitHubActions

  ChatLambda -->|uses| Gemini[(Google Gemini API - mock)]
  ChatLambda --> Slack
  SNS --> ChatLambda
